/*
 * jQuery Paginated Drop Down UI Widget 1.0
 * Copyright (c) 2012 Kapil Kashyap
 *
 * Depends:
 *   - jQuery 1.6+
 *   - jQuery UI 1.8 widget factory
 *   - jQuery Filter Json plugin // optional
 *
 * Dual licensed under the MIT and GPL licenses:
 *   - http://www.opensource.org/licenses/mit-license.php
 *   - http://www.gnu.org/licenses/gpl.html
 */
(function(a){a.widget("kk.paginateddropdown",{options:{url:null,itemTemplate:null,valueProperty:null,itemsPerPage:10,dropdownWidth:null,elementType:"text",persistState:false,closeBtnRequired:true,footerRequired:true,keyNavigation:{up_down:true,next_prev:true},customEventPrefix:null,filterJSON:null,cache:false},_create:function(){var b=null,c=null,d=0;this._setWidgetProperties();b=a("<div></div>").addClass(this.wp.widgetBaseClass+this.wp.hyphen+this.options.elementType+this.wp.hyphen+this.wp.wrapperLabel);this.element.wrap(b.width(this.element.width()+(a.browser.msie?2:0)));this._setWidgetState();this.element.addClass(this.wp.widgetBaseClass);if(this.options.dropdownWidth){d=parseInt(this.options.dropdownWidth,10);this.options.dropdownWidth=d?d:0}c=parseInt(this.options.itemsPerPage,10);if(!c||c<=0){this.options.itemsPerPage=10}this._bindEvents();this._constructPaginationFooterTemplate()},_init:function(b){b=b||this.options;a.ajaxSetup({cache:b.cache});this._checkDependencies()},_checkDependencies:function(){if(this.options.filterJSON&&!a.fn.filterJSON){var b="jQuery filter json plugin is required.";if(window.console){console.error(b,this.element.context);return}alert(b)}},_setWidgetProperties:function(){if(this.options.customEventPrefix){this.widgetEventPrefix=this.options.customEventPrefix}this.wp={};this.wp.widgetBaseClass="paginateddropdown";this.wp.selectedItemClass="selected-item";this.wp.space=" ";this.wp.hyphen="-";this.wp.ofLabel="of";this.wp.wrapperLabel="wrapper";this.wp.containerLabel="container";this.wp.itemLabel="item";this.wp.footerLabel="footer";this.wp.footerContentLabel="footer-content";this.wp.footerInfoLabel="footer-info";this.wp.footerLeftNavLabel="footer-left-nav";this.wp.footerRightNavLabel="footer-right-nav";this.wp.closeBtnLabel="close-button";this.wp.itemSelectedEvent="itemselected"},_bindEvents:function(){var b=this,c=b.element;if(b.options.elementType&&b.options.elementType=="text"){c.keydown(function(a){b._keyNavigations(a)});c.keypress(function(d){if(d.keyCode==13){d.preventDefault();if(a(c.parent().find("."+b.wp.selectedItemClass)).length>0){b._itemSelection(d)}return}});c.keyup(function(d){if(c.val()==""||d.keyCode==27){if(c.val()==""||!b.options.persistState){b._resetWidgetState()}b._cleanup();return}b._fetchData(a.trim(c.val()))})}else if(b.options.elementType&&b.options.elementType=="link"){c.click(function(a){b._fetchData()});c.keyup(function(a){if(a.keyCode==27){if(!b.options.persistState){b._resetWidgetState()}b._cleanup()}})}c.blur(function(a){setTimeout(function(){if(c.is(":focus")){return false}if(!b.options.persistState){b._resetWidgetState()}b._cleanup()},200)})},_updateContent:function(b){var c=this.element;if(this.options.valueProperty){if(a.type(b)=="object"){c.val(b[this.options.valueProperty]).focus()}else{c.val(b).focus()}}else{c.val(a(c.parent().find("."+this.wp.selectedItemClass)).text()).focus()}},_keyNavigations:function(b){var c=this,d=c.element,e=a(d.parent().find("."+c.wp.selectedItemClass)),f=null,g=null;if(c._getWidgetState().html){if(c.options.keyNavigation.next_prev&&b.keyCode==37){c._prevPage(b,c);return}else if(c.options.keyNavigation.next_prev&&b.keyCode==39){c._nextPage(b,c);return}else if(c.options.keyNavigation.up_down&&b.keyCode==38){b.preventDefault();g=c._getWidgetState().endIndex-c._getWidgetState().startIndex+1;f=e.prev().index();if(f!=-1){g=f+1}c._highlightItem(g);return}else if(c.options.keyNavigation.up_down&&b.keyCode==40){b.preventDefault();g=1;f=e.next().hasClass(c.wp.widgetBaseClass+c.wp.hyphen+c.wp.footerLabel)?-1:e.next().index();if(f!=-1){g=f+1}c._highlightItem(g);return}}},_itemSelection:function(a){this._updateContent(this._getSelectedItemObject());this._cleanup();this._fireEvent(this.wp.itemSelectedEvent,a)},_nextPage:function(a,b){var c=b._getWidgetState();b.element.focus();if(c.page<c.maximumNumberOfPages){c.page++;b._paginate();b.element.parent().find("."+b.wp.widgetBaseClass+b.wp.hyphen+b.wp.containerLabel).html(c.html);b._updateFooterInfo();b._bindDropdownComponentEvents();b._highlightItem(1);b._markAllItems()}},_prevPage:function(a,b){var c=b._getWidgetState();b.element.focus();if(c.page>1){c.page--;b._paginate();b.element.parent().find("."+b.wp.widgetBaseClass+b.wp.hyphen+b.wp.containerLabel).html(c.html);b._updateFooterInfo();b._bindDropdownComponentEvents();b._highlightItem(1);b._markAllItems()}},_fetchData:function(b){var c=this,d=c._getWidgetState();if(c.options.url){d.query=b;a.getJSON(c.options.url,{q:b},function(e){var f=null;if(c.options.filterJSON&&a.fn.filterJSON){f=a.fn.filterJSON(e,a.extend({property:c.options.valueProperty,value:b,checkContains:true,wrapper:true},c.options.filterJSON))}d.fetchedData=d.data=f?f:e;c._constructDropDown()})}},_constructDropDown:function(){var a=this._getWidgetState().data;this._cleanup();if(a==null||a.length==0){this._resetWidgetState();return}if(this.options.itemTemplate){this._getWidgetState().data=this._constructHtmlUsingTemplate()}this._paginate();this._createDropdownComponents();this._updateFooterInfo();this._bindDropdownComponentEvents();this._highlightItem(this._getWidgetState().highlightedIndex);this._markAllItems()},_constructHtmlUsingTemplate:function(){var b=this,c=b._getWidgetState().data,d=[];if(!c){var e="data is required.";if(window.console){console.error?console.error(e):console.log(e);return}alert(e);return}a(c).each(function(c,e){var f=a("<div></div>").html(b.options.itemTemplate).html();if(a.type(e)=="object"){a.each(e,function(a,c){var d="{@:"+a+"}",e=new RegExp(d,"g");if(b.options.itemTemplate.indexOf(d)!=-1){f=f.replace(e,c)}})}else{var g="{@:"+b.options.valueProperty+"}",h=new RegExp(g,"g");if(b.options.itemTemplate.indexOf(g)!=-1){f=f.replace(h,e)}}d.push(f)});return d},_paginate:function(){var a=this,b=a._getWidgetState(),c=a.options.itemsPerPage,d=null,e=[];if(b.data&&b.data.length){if(b.data.length!=b.totalResults){b.page=1;b.highlightedIndex=1}b.totalResults=b.data.length}b.maximumNumberOfPages=Math.floor(b.totalResults/c);if(b.totalResults%c>0){b.maximumNumberOfPages++}if(b.totalResults>0){d=c*b.page;b.startIndex=d-c;for(var f=d-c;f<d;f++){if(f==b.totalResults){break}e.push(b.data[f])}b.endIndex=--f}if(b.maximumNumberOfPages>1){e.push(b.paginationFooter)}b.html=e.join("")},_createDropdownComponents:function(){var b=this,c=b.element.parent().position(),d=a("<div></div>",{"class":b.wp.widgetBaseClass+b.wp.hyphen+b.wp.closeBtnLabel,html:'<div class="x-close-btn-icon"/>',click:function(a){a.preventDefault();b._cleanup()}}),e=a("<div></div>",{"class":b.wp.widgetBaseClass+b.wp.hyphen+b.wp.containerLabel,width:b.options.dropdownWidth>0?b.options.dropdownWidth:b.element.parent().width(),html:b._getWidgetState().html});b.element.parent().append(e);e.position({my:"top",at:"bottom",of:b.element.parent(),offset:"0 -1"}).css("left",c.left+"px");if(b.options.closeBtnRequired){b.element.parent().append(d);d.position({my:"left top",at:"right top",of:e,offset:"-5 -5"})}},_updateFooterInfo:function(){if(this.options.footerRequired){var a=this._getWidgetState(),b=null;if(a.maximumNumberOfPages>1){b=a.startIndex+1+this.wp.space+this.wp.hyphen+this.wp.space+(a.endIndex+1)+this.wp.space+this.wp.ofLabel+this.wp.space+a.totalResults;this.element.parent().find("."+this.wp.widgetBaseClass+this.wp.hyphen+this.wp.footerInfoLabel).html(b)}}},_bindDropdownComponentEvents:function(){var b=this,c=b.element.parent();if(b.options.footerRequired){c.find("."+b.wp.widgetBaseClass+b.wp.hyphen+b.wp.footerLabel).bind("click dblclick",function(a){b.element.focus()});c.find("."+b.wp.widgetBaseClass+b.wp.hyphen+b.wp.footerRightNavLabel).bind("click dblclick",function(a){b._nextPage(a,b)});c.find("."+b.wp.widgetBaseClass+b.wp.hyphen+b.wp.footerLeftNavLabel).bind("click dblclick",function(a){b._prevPage(a,b)})}c.find("."+b.wp.widgetBaseClass+b.wp.hyphen+b.wp.containerLabel+" > div").each(function(c,d){if(!a(d).hasClass(b.wp.widgetBaseClass+b.wp.hyphen+b.wp.footerLabel)){a(d).click(function(a){b._highlightItem(c+1);b._itemSelection(a)})}})},_constructPaginationFooterTemplate:function(){if(this.options.footerRequired){var a=this._getWidgetState();a.paginationFooter='<div class="'+this.wp.widgetBaseClass+this.wp.hyphen+this.wp.footerLabel+'">';a.paginationFooter+='<div class="'+this.wp.widgetBaseClass+this.wp.hyphen+this.wp.footerContentLabel+'">';a.paginationFooter+='<span class="'+this.wp.widgetBaseClass+this.wp.hyphen+this.wp.footerLeftNavLabel+'"><</span>';a.paginationFooter+='<span class="'+this.wp.widgetBaseClass+this.wp.hyphen+this.wp.footerInfoLabel+'"></span>';a.paginationFooter+='<span class="'+this.wp.widgetBaseClass+this.wp.hyphen+this.wp.footerRightNavLabel+'">></span>';a.paginationFooter+="</div>";a.paginationFooter+="</div>"}},_highlightItem:function(a){this._removeItemHighlight();this._getWidgetState().highlightedIndex=a;this.element.parent().find("."+this.wp.widgetBaseClass+this.wp.hyphen+this.wp.containerLabel+" > div:nth-child( "+a+" )").addClass(this.wp.selectedItemClass)},_markAllItems:function(){var b=this,c=this.element.siblings("."+this.wp.widgetBaseClass+this.wp.hyphen+this.wp.containerLabel).children();c.each(function(c,d){if(!a(d).hasClass(b.wp.widgetBaseClass+b.wp.hyphen+b.wp.footerLabel)){a(d).addClass(b.wp.widgetBaseClass+b.wp.hyphen+b.wp.itemLabel)}})},_removeItemHighlight:function(a){if(!a){a=this.element.parent().find("."+this.wp.widgetBaseClass+this.wp.hyphen+this.wp.containerLabel+" > div."+this.wp.selectedItemClass)}a.removeClass(this.wp.selectedItemClass)},_cleanup:function(){if(this.options.closeBtnRequired){this.element.parent().find("."+this.wp.widgetBaseClass+this.wp.hyphen+this.wp.closeBtnLabel).remove()}this.element.parent().find("."+this.wp.widgetBaseClass+this.wp.hyphen+this.wp.containerLabel).remove()},_setWidgetState:function(){var a={page:1,html:null,startIndex:1,endIndex:1,totalResults:0,paginationFooter:"",highlightedIndex:1,maximumNumberOfPages:0,data:null,fetchedData:null};this.element.data({widgetState:a});this._constructPaginationFooterTemplate()},_getWidgetState:function(){return this.element.data("widgetState")},_resetWidgetState:function(){this._setWidgetState()},_fireEvent:function(a,b,c){if(a===this.wp.itemSelectedEvent&&!c){c=this._getSelectedItemObject()}this._resetWidgetState();this._trigger(a,b,c)},_getSelectedItemObject:function(){var a={},b=this._getWidgetState(),c=b.fetchedData;if(c&&c.length>0){a=c[b.startIndex+b.highlightedIndex-1]}return a},_setOption:function(b,c){if(this._super){this._super(b,c);return}a.Widget.prototype._setOption.apply(this,arguments)},_setOptions:function(b){if(this._super){this._super(b);return}a.Widget.prototype._setOptions.apply(this,arguments)},destroy:function(){this._cleanup();this.element.removeClass(this.wp.widgetBaseClass).unwrap();this.element.unbind();a.Widget.prototype.destroy.call(this)}})})(jQuery)