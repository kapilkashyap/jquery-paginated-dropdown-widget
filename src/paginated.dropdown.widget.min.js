/*
 * jQuery Paginated Drop Down UI Widget 1.0
 * Copyright (c) 2012 Kapil Kashyap
 *
 * Depends:
 *   - jQuery 1.6+
 *   - jQuery UI 1.8 widget factory
 *   - jQuery Filter Json plugin // optional
 *
 * Dual licensed under the MIT and GPL licenses:
 *   - http://www.opensource.org/licenses/mit-license.php
 *   - http://www.gnu.org/licenses/gpl.html
 */
(function(e){e.widget("kk.paginateddropdown",{options:{url:null,itemTemplate:null,valueProperty:null,itemsPerPage:10,dropdownWidth:null,elementType:"text",persistState:false,closeBtnRequired:true,footerRequired:true,keyNavigation:{up_down:true,next_prev:true},customEventPrefix:null,filterJSON:null,cache:false},_create:function(){var t=null,n=null,r=0;this._setWidgetProperties();t=e("<div></div>").addClass(this.wp.widgetBaseClass+this.wp.hyphen+this.options.elementType+this.wp.hyphen+this.wp.wrapperLabel);this.element.wrap(t.width(parseInt(this.element.css("width"),10)+(e.browser.msie?2:0)));this._setWidgetState();this.element.addClass(this.wp.widgetBaseClass);if(this.options.dropdownWidth){r=parseInt(this.options.dropdownWidth,10);this.options.dropdownWidth=r?r:0}n=parseInt(this.options.itemsPerPage,10);if(!n||n<=0){this.options.itemsPerPage=10}this._bindEvents();this._constructPaginationFooterTemplate()},_init:function(t){t=t||this.options;e.ajaxSetup({cache:t.cache});this._checkDependencies()},_checkDependencies:function(){if(this.options.filterJSON&&!e.fn.filterJSON){var t="jQuery filter json plugin is required.";if(window.console){console.error(t,this.element.context);return}alert(t)}},_setWidgetProperties:function(){if(this.options.customEventPrefix){this.widgetEventPrefix=this.options.customEventPrefix}this.wp={};this.wp.widgetBaseClass="paginateddropdown";this.wp.selectedItemClass="selected-item";this.wp.space=" ";this.wp.hyphen="-";this.wp.ofLabel="of";this.wp.wrapperLabel="wrapper";this.wp.containerLabel="container";this.wp.itemLabel="item";this.wp.footerLabel="footer";this.wp.footerContentLabel="footer-content";this.wp.footerInfoLabel="footer-info";this.wp.footerLeftNavLabel="footer-left-nav";this.wp.footerRightNavLabel="footer-right-nav";this.wp.closeBtnLabel="close-button";this.wp.itemSelectedEvent="itemselected"},_bindEvents:function(){var t=this,n=t.element;if(t.options.elementType&&t.options.elementType=="text"){n.keydown(function(e){t._keyNavigations(e)});n.keypress(function(r){if(r.keyCode==13){r.preventDefault();if(e(n.parent().find("."+t.wp.selectedItemClass)).length>0){t._itemSelection(r)}return}});n.keyup(function(r){if(n.val()==""||r.keyCode==27){if(n.val()==""||!t.options.persistState){t._resetWidgetState()}t._cleanup();return}t._fetchData(e.trim(n.val()))})}else if(t.options.elementType&&t.options.elementType=="link"){n.click(function(e){t._fetchData()});n.keyup(function(e){if(e.keyCode==27){if(!t.options.persistState){t._resetWidgetState()}t._cleanup()}})}n.blur(function(e){setTimeout(function(){if(n.is(":focus")){return false}if(!t.options.persistState){t._resetWidgetState()}t._cleanup()},200)})},_updateContent:function(t){var n=this.element;if(this.options.valueProperty){if(e.type(t)=="object"){n.val(t[this.options.valueProperty]).focus()}else{n.val(t).focus()}}else{n.val(e(n.parent().find("."+this.wp.selectedItemClass)).text()).focus()}},_keyNavigations:function(t){var n=this,r=n.element,i=e(r.parent().find("."+n.wp.selectedItemClass)),s=null,o=null;if(n._getWidgetState().html){if(n.options.keyNavigation.next_prev&&t.keyCode==37){n._prevPage(t,n);return}else if(n.options.keyNavigation.next_prev&&t.keyCode==39){n._nextPage(t,n);return}else if(n.options.keyNavigation.up_down&&t.keyCode==38){t.preventDefault();o=n._getWidgetState().endIndex-n._getWidgetState().startIndex+1;s=i.prev().index();if(s!=-1){o=s+1}n._highlightItem(o);return}else if(n.options.keyNavigation.up_down&&t.keyCode==40){t.preventDefault();o=1;s=i.next().hasClass(n.wp.widgetBaseClass+n.wp.hyphen+n.wp.footerLabel)?-1:i.next().index();if(s!=-1){o=s+1}n._highlightItem(o);return}}},_itemSelection:function(e){this._updateContent(this._getSelectedItemObject());this._cleanup();this._fireEvent(this.wp.itemSelectedEvent,e)},_nextPage:function(e,t){var n=t._getWidgetState();t.element.focus();if(n.page<n.maximumNumberOfPages){n.page++;t._paginate();t.element.parent().find("."+t.wp.widgetBaseClass+t.wp.hyphen+t.wp.containerLabel).html(n.html);t._updateFooterInfo();t._bindDropdownComponentEvents();t._highlightItem(1);t._markAllItems()}},_prevPage:function(e,t){var n=t._getWidgetState();t.element.focus();if(n.page>1){n.page--;t._paginate();t.element.parent().find("."+t.wp.widgetBaseClass+t.wp.hyphen+t.wp.containerLabel).html(n.html);t._updateFooterInfo();t._bindDropdownComponentEvents();t._highlightItem(1);t._markAllItems()}},_fetchData:function(t){var n=this,r=n._getWidgetState();if(n.options.url){r.query=t;e.getJSON(n.options.url,{q:t},function(i){var s=null;if(n.options.filterJSON&&e.fn.filterJSON){s=e.fn.filterJSON(i,e.extend({property:n.options.valueProperty,value:t,checkContains:true,wrapper:true},n.options.filterJSON))}r.fetchedData=r.data=s?s:i;n._constructDropDown()})}},_constructDropDown:function(){var e=this._getWidgetState().data;this._cleanup();if(e==null||e.length==0){this._resetWidgetState();return}if(this.options.itemTemplate){this._getWidgetState().data=this._constructHtmlUsingTemplate()}this._paginate();this._createDropdownComponents();this._updateFooterInfo();this._bindDropdownComponentEvents();this._highlightItem(this._getWidgetState().highlightedIndex);this._markAllItems()},_constructHtmlUsingTemplate:function(){var t=this,n=t._getWidgetState().data,r=[];if(!n){var i="data is required.";if(window.console){console.error?console.error(i):console.log(i);return}alert(i);return}e(n).each(function(n,i){var s=e("<div></div>").html(t.options.itemTemplate).html();if(e.type(i)=="object"){e.each(i,function(e,n){var r="{@:"+e+"}",i=new RegExp(r,"g");if(t.options.itemTemplate.indexOf(r)!=-1){s=s.replace(i,n)}})}else{var o="{@:"+t.options.valueProperty+"}",u=new RegExp(o,"g");if(t.options.itemTemplate.indexOf(o)!=-1){s=s.replace(u,i)}}r.push(s)});return r},_paginate:function(){var e=this,t=e._getWidgetState(),n=e.options.itemsPerPage,r=null,i=[];if(t.data&&t.data.length){if(t.data.length!=t.totalResults){t.page=1;t.highlightedIndex=1}t.totalResults=t.data.length}t.maximumNumberOfPages=Math.floor(t.totalResults/n);if(t.totalResults%n>0){t.maximumNumberOfPages++}if(t.totalResults>0){r=n*t.page;t.startIndex=r-n;for(var s=r-n;s<r;s++){if(s==t.totalResults){break}i.push(t.data[s])}t.endIndex=--s}if(t.maximumNumberOfPages>1){i.push(t.paginationFooter)}t.html=i.join("")},_createDropdownComponents:function(){var t=this,n=t.element.parent().position(),r=e("<div></div>",{"class":t.wp.widgetBaseClass+t.wp.hyphen+t.wp.closeBtnLabel,html:'<div class="x-close-btn-icon"/>',click:function(e){e.preventDefault();t._cleanup()}}),i=e("<div></div>",{"class":t.wp.widgetBaseClass+t.wp.hyphen+t.wp.containerLabel,width:t.options.dropdownWidth>0?t.options.dropdownWidth:t.element.parent().width(),html:t._getWidgetState().html});t.element.parent().append(i);i.position({my:"top",at:"bottom",of:t.element.parent(),offset:"0 -1"}).css("left",n.left+"px");if(t.options.closeBtnRequired){t.element.parent().append(r);r.position({my:"left top",at:"right top",of:i,offset:"-5 -5"})}},_updateFooterInfo:function(){if(this.options.footerRequired){var e=this._getWidgetState(),t=null;if(e.maximumNumberOfPages>1){t=e.startIndex+1+this.wp.space+this.wp.hyphen+this.wp.space+(e.endIndex+1)+this.wp.space+this.wp.ofLabel+this.wp.space+e.totalResults;this.element.parent().find("."+this.wp.widgetBaseClass+this.wp.hyphen+this.wp.footerInfoLabel).html(t)}}},_bindDropdownComponentEvents:function(){var t=this,n=t.element.parent();if(t.options.footerRequired){n.find("."+t.wp.widgetBaseClass+t.wp.hyphen+t.wp.footerLabel).bind("click dblclick",function(e){t.element.focus()});n.find("."+t.wp.widgetBaseClass+t.wp.hyphen+t.wp.footerRightNavLabel).bind("click dblclick",function(e){t._nextPage(e,t)});n.find("."+t.wp.widgetBaseClass+t.wp.hyphen+t.wp.footerLeftNavLabel).bind("click dblclick",function(e){t._prevPage(e,t)})}n.find("."+t.wp.widgetBaseClass+t.wp.hyphen+t.wp.containerLabel+" > div").each(function(n,r){if(!e(r).hasClass(t.wp.widgetBaseClass+t.wp.hyphen+t.wp.footerLabel)){e(r).click(function(e){t._highlightItem(n+1);t._itemSelection(e)})}})},_constructPaginationFooterTemplate:function(){if(this.options.footerRequired){var e=this._getWidgetState();e.paginationFooter='<div class="'+this.wp.widgetBaseClass+this.wp.hyphen+this.wp.footerLabel+'">';e.paginationFooter+='<div class="'+this.wp.widgetBaseClass+this.wp.hyphen+this.wp.footerContentLabel+'">';e.paginationFooter+='<span class="'+this.wp.widgetBaseClass+this.wp.hyphen+this.wp.footerLeftNavLabel+'"><</span>';e.paginationFooter+='<span class="'+this.wp.widgetBaseClass+this.wp.hyphen+this.wp.footerInfoLabel+'"></span>';e.paginationFooter+='<span class="'+this.wp.widgetBaseClass+this.wp.hyphen+this.wp.footerRightNavLabel+'">></span>';e.paginationFooter+="</div>";e.paginationFooter+="</div>"}},_highlightItem:function(e){this._removeItemHighlight();this._getWidgetState().highlightedIndex=e;this.element.parent().find("."+this.wp.widgetBaseClass+this.wp.hyphen+this.wp.containerLabel+" > div:nth-child( "+e+" )").addClass(this.wp.selectedItemClass)},_markAllItems:function(){var t=this,n=this.element.siblings("."+this.wp.widgetBaseClass+this.wp.hyphen+this.wp.containerLabel).children();n.each(function(n,r){if(!e(r).hasClass(t.wp.widgetBaseClass+t.wp.hyphen+t.wp.footerLabel)){e(r).addClass(t.wp.widgetBaseClass+t.wp.hyphen+t.wp.itemLabel)}})},_removeItemHighlight:function(e){if(!e){e=this.element.parent().find("."+this.wp.widgetBaseClass+this.wp.hyphen+this.wp.containerLabel+" > div."+this.wp.selectedItemClass)}e.removeClass(this.wp.selectedItemClass)},_cleanup:function(){if(this.options.closeBtnRequired){this.element.parent().find("."+this.wp.widgetBaseClass+this.wp.hyphen+this.wp.closeBtnLabel).remove()}this.element.parent().find("."+this.wp.widgetBaseClass+this.wp.hyphen+this.wp.containerLabel).remove()},_setWidgetState:function(){var e={page:1,html:null,startIndex:1,endIndex:1,totalResults:0,paginationFooter:"",highlightedIndex:1,maximumNumberOfPages:0,data:null,fetchedData:null};this.element.data({widgetState:e});this._constructPaginationFooterTemplate()},_getWidgetState:function(){return this.element.data("widgetState")},_resetWidgetState:function(){this._setWidgetState()},_fireEvent:function(e,t,n){if(e===this.wp.itemSelectedEvent&&!n){n=this._getSelectedItemObject()}this._resetWidgetState();this._trigger(e,t,n)},_getSelectedItemObject:function(){var e={},t=this._getWidgetState(),n=t.fetchedData;if(n&&n.length>0){e=n[t.startIndex+t.highlightedIndex-1]}return e},_setOption:function(t,n){if(this._super){this._super(t,n);return}e.Widget.prototype._setOption.apply(this,arguments)},_setOptions:function(t){if(this._super){this._super(t);return}e.Widget.prototype._setOptions.apply(this,arguments)},destroy:function(){this._cleanup();this.element.removeClass(this.wp.widgetBaseClass).unwrap();this.element.unbind();e.Widget.prototype.destroy.call(this)}})})(jQuery)